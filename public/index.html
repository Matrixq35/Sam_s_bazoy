<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Telegram WebApp</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #one {
            background-color: blanchedalmond;
            width: 500px;
            height: 250px;
            padding: 15px;
            border-radius: 20px;
            text-align: center;
        }
    </style>
</head>

<body>
    <div id="one">
        <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="username">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>!</h2>
        <p id="balance">–ë–∞–ª–∞–Ω—Å: 0</p>
        <button id="tapButton">–î–æ–±–∞–≤–∏—Ç—å 1</button>
        <br><br>
        <a href="/download-db" download>
            <button>üì• –°–∫–∞—á–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö</button>
        </a>
    </div>
    <script>
        const balanceHTML = document.getElementById("balance");
        const button = document.getElementById("tapButton");

        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const user_id = tg.initDataUnsafe?.user?.id || "test_user";

        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
        let balance = 0;

        async function getBalance() {
            try {
                const response = await fetch(`/balance/${user_id}`);
                const data = await response.json();
                balance = data.balance; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–∞–ª–∞–Ω—Å –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
                balanceHTML.textContent = `–ë–∞–ª–∞–Ω—Å: ${balance}`;
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞:", error);
            }
        }

        async function saveBalance() {
            try {
                await fetch("/balance/update", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id: user_id, balance: balance }),
                });
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞:", error);
            }
        }

        button.addEventListener("click", () => {
            balance += 1; // –õ–æ–∫–∞–ª—å–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –±–∞–ª–∞–Ω—Å
            balanceHTML.textContent = `–ë–∞–ª–∞–Ω—Å: ${balance}`;
            saveBalance(); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        });

        getBalance(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–ª–∞–Ω—Å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    </script>
</body>

</html>